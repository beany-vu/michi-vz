"use strict";(self.webpackChunkmichi_vz=self.webpackChunkmichi_vz||[]).push([[173],{"./src/components/RangeChart.tsx":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),d3__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./node_modules/d3/src/index.js"),_MichiVzProvider__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./src/components/MichiVzProvider.tsx"),_shared_Title__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/components/shared/Title.tsx"),_shared_XaxisLinear__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/components/shared/XaxisLinear.tsx"),_shared_YaxisLinear__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__("./src/components/shared/YaxisLinear.tsx"),_hooks_useDisplayIsNodata__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__("./src/components/hooks/useDisplayIsNodata.ts"),_shared_LoadingIndicator__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__("./src/components/shared/LoadingIndicator.tsx"),use_deep_compare_effect__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__("./node_modules/use-deep-compare-effect/dist/use-deep-compare-effect.esm.js");function _toConsumableArray(r){return function _arrayWithoutHoles(r){if(Array.isArray(r))return _arrayLikeToArray(r)}(r)||function _iterableToArray(r){if("undefined"!=typeof Symbol&&null!=r[Symbol.iterator]||null!=r["@@iterator"])return Array.from(r)}(r)||_unsupportedIterableToArray(r)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _slicedToArray(r,e){return function _arrayWithHoles(r){if(Array.isArray(r))return r}(r)||function _iterableToArrayLimit(r,l){var t=null==r?null:"undefined"!=typeof Symbol&&r[Symbol.iterator]||r["@@iterator"];if(null!=t){var e,n,i,u,a=[],f=!0,o=!1;try{if(i=(t=t.call(r)).next,0===l){if(Object(t)!==t)return;f=!1}else for(;!(f=(e=i.call(t)).done)&&(a.push(e.value),a.length!==l);f=!0);}catch(r){o=!0,n=r}finally{try{if(!f&&null!=t.return&&(u=t.return(),Object(u)!==u))return}finally{if(o)throw n}}return a}}(r,e)||_unsupportedIterableToArray(r,e)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(r,a){if(r){if("string"==typeof r)return _arrayLikeToArray(r,a);var t={}.toString.call(r).slice(8,-1);return"Object"===t&&r.constructor&&(t=r.constructor.name),"Map"===t||"Set"===t?Array.from(r):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(r,a):void 0}}function _arrayLikeToArray(r,a){(null==a||a>r.length)&&(a=r.length);for(var e=0,n=Array(a);e<a;e++)n[e]=r[e];return n}var MARGIN={top:50,right:50,bottom:50,left:50},WIDTH=900-MARGIN.left-MARGIN.right,HEIGHT=480-MARGIN.top-MARGIN.bottom,RangeChart=function RangeChart(_ref){var dataSet=_ref.dataSet,title=_ref.title,_ref$width=_ref.width,width=void 0===_ref$width?WIDTH:_ref$width,_ref$height=_ref.height,height=void 0===_ref$height?HEIGHT:_ref$height,_ref$margin=_ref.margin,margin=void 0===_ref$margin?MARGIN:_ref$margin,yAxisDomain=_ref.yAxisDomain,yAxisFormat=_ref.yAxisFormat,_ref$xAxisDataType=_ref.xAxisDataType,xAxisDataType=void 0===_ref$xAxisDataType?"number":_ref$xAxisDataType,xAxisFormat=_ref.xAxisFormat,_ref$tooltipFormatter=_ref.tooltipFormatter,tooltipFormatter=void 0===_ref$tooltipFormatter?function(d){return"<div>".concat(d.label," - ").concat(d.date,": ").concat(null==d?void 0:d.valueMedium,"</div>")}:_ref$tooltipFormatter,_ref$showCombined=_ref.showCombined,showCombined=void 0!==_ref$showCombined&&_ref$showCombined,children=_ref.children,_ref$isLoading=_ref.isLoading,isLoading=void 0!==_ref$isLoading&&_ref$isLoading,isLoadingComponent=_ref.isLoadingComponent,isNodataComponent=_ref.isNodataComponent,isNodata=_ref.isNodata,onChartDataProcessed=_ref.onChartDataProcessed,onHighlightItem=_ref.onHighlightItem,_useChartContext=(0,_MichiVzProvider__WEBPACK_IMPORTED_MODULE_2__.N)(),colorsMapping=_useChartContext.colorsMapping,highlightItems=_useChartContext.highlightItems,disabledItems=_useChartContext.disabledItems,svgRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),tooltipRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),renderCompleteRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(!1),prevChartDataRef=(0,react__WEBPACK_IMPORTED_MODULE_0__.useRef)(null),filteredDataSet=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((function(){return dataSet.filter((function(d){return!disabledItems.includes(d.label)}))}),[dataSet,disabledItems]),yScale=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((function(){return d3__WEBPACK_IMPORTED_MODULE_1__.scaleLinear().domain(yAxisDomain||[d3__WEBPACK_IMPORTED_MODULE_1__.min(filteredDataSet.flatMap((function(_ref2){return _ref2.series.filter((function(dd){return null!==dd.valueMin}))})),(function(d){return d.valueMin}))||0,d3__WEBPACK_IMPORTED_MODULE_1__.max(filteredDataSet.flatMap((function(_ref3){return _ref3.series.filter((function(dd){return null!==dd.valueMax}))})),(function(d){return d.valueMax}))||1]).range([height-margin.bottom,margin.top]).clamp(!0).nice()}),[filteredDataSet,width,height,margin,yAxisDomain]),xScale=(0,react__WEBPACK_IMPORTED_MODULE_0__.useMemo)((function(){if("number"===xAxisDataType)return d3__WEBPACK_IMPORTED_MODULE_1__.scaleLinear().domain([d3__WEBPACK_IMPORTED_MODULE_1__.min(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return d.date}))})))||0,d3__WEBPACK_IMPORTED_MODULE_1__.max(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return d.date}))})))||1]).range([margin.left,width-margin.right]).clamp(!0).nice();if("date_annual"===xAxisDataType){var _minDate=d3__WEBPACK_IMPORTED_MODULE_1__.min(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return new Date("".concat(d.date,"-01-01"))}))}))),_maxDate=d3__WEBPACK_IMPORTED_MODULE_1__.max(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return new Date("".concat(d.date))}))})));return d3__WEBPACK_IMPORTED_MODULE_1__.scaleTime().domain([_minDate||0,_maxDate||1]).range([margin.left,width-margin.right])}var minDate=d3__WEBPACK_IMPORTED_MODULE_1__.min(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return new Date(d.date)}))}))),maxDate=d3__WEBPACK_IMPORTED_MODULE_1__.max(filteredDataSet.flatMap((function(item){return item.series.map((function(d){return new Date(d.date)}))})));return d3__WEBPACK_IMPORTED_MODULE_1__.scaleTime().domain([minDate||0,maxDate||1]).range([margin.left,width-margin.right])}),[filteredDataSet,width,height,margin,xAxisDataType]),getAreaGenerator=d3__WEBPACK_IMPORTED_MODULE_1__.area().x((function(d){return xScale(new Date(d.date))})).y0((function(d){return yScale(d.valueMin)})).y1((function(d){return yScale(d.valueMax)})).curve(d3__WEBPACK_IMPORTED_MODULE_1__.curveBumpX),getLineGenerator=d3__WEBPACK_IMPORTED_MODULE_1__.line().x((function(d){return xScale(new Date(d.date))})).y((function(d){return yScale((d.valueMax+d.valueMin)/2)})).curve(d3__WEBPACK_IMPORTED_MODULE_1__.curveBumpX),showLine=function showLine(d){return d.valueMin===d.valueMax};(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){var svg=d3__WEBPACK_IMPORTED_MODULE_1__.select(svgRef.current);svg.selectAll(".line").remove(),svg.selectAll(".line-overlay").remove(),svg.selectAll(".circle-data").remove(),svg.selectAll(".area-group").remove();var areas=svg.selectAll(".area-group").data(filteredDataSet).enter().append("g");areas.append("path").attr("class",(function(_,i){return"area area-".concat(i," area-group")})).attr("d",(function(d){return showLine(d.series[0])?getLineGenerator(d.series):getAreaGenerator(d.series)})).attr("fill",(function(d){return showLine(d.series[0])?"none":colorsMapping[d.label]||d.color})).attr("stroke",(function(d){return showLine(d.series[0])?colorsMapping[d.label]||d.color:"none"})).attr("data-label",(function(d){return d.label})).attr("transition","all 0.1s ease-out").on("mouseenter",(function(event){var label=d3__WEBPACK_IMPORTED_MODULE_1__.select(this).attr("label");event.preventDefault(),d3__WEBPACK_IMPORTED_MODULE_1__.select(this).raise(),areas.selectAll(".area-group").attr("opacity",.1),d3__WEBPACK_IMPORTED_MODULE_1__.select(this).attr("opacity",1),svg.selectAll(".rect-hover").attr("opacity",0),svg.selectAll('.rect-hover[data-label="'.concat(label,'"]')).attr("opacity",1)})).on("mouseout",(function(event){event.relatedTarget&&event.relatedTarget.classList.contains("rect-hover")||(event.preventDefault(),areas.selectAll(".area-group").attr("opacity",.8),svg.selectAll(".rect-hover").attr("opacity",0))})),filteredDataSet.forEach((function(data,i){svg.selectAll(".rect-hover-".concat(i)).data(data.series).enter().append("rect").attr("class","rect-hover rect-hover-".concat(i)).attr("stroke","#ccc").attr("data-label",data.label).attr("x",(function(d){return xScale(new Date(d.date))-2})).attr("y",(function(d){return yScale(d.valueMax)})).attr("width",4).attr("height",(function(d){return Math.abs(yScale(d.valueMax)-yScale(d.valueMin))})).attr("fill","white").attr("opacity",0).on("mouseenter",(function(event,d){event.preventDefault(),event.stopPropagation(),onHighlightItem([data.label]),function showTooltip(event,content){var tooltip=tooltipRef.current,_d3$pointer2=_slicedToArray(d3__WEBPACK_IMPORTED_MODULE_1__.pointer(event,svgRef.current),2),x=_d3$pointer2[0],y=_d3$pointer2[1];tooltip&&(tooltip.innerHTML=content,tooltip.style.opacity="1",tooltip.style.left=x+10+"px",tooltip.style.top=y-window.scrollY-10+"px")}(event,tooltipFormatter(d,data.series,filteredDataSet))})).on("mouseleave",(function(event){event.preventDefault(),event.stopPropagation(),onHighlightItem([]),function hideTooltip(){var tooltip=tooltipRef.current;tooltip&&(tooltip.style.opacity="0")}()}))}))}),[yScale,xScale,width,height,margin,filteredDataSet,xAxisDataType]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){d3__WEBPACK_IMPORTED_MODULE_1__.select(svgRef.current).selectAll(".axis").remove()}),[filteredDataSet,width,height,margin,xAxisDataType,yAxisFormat]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){}),[colorsMapping]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){var svg=d3__WEBPACK_IMPORTED_MODULE_1__.select(svgRef.current);highlightItems.forEach((function(item){svg.selectAll('[data-label]:not([data-label="'.concat(item,'"])')).attr("opacity",.1),svg.selectAll('.rect-hover[data-label="'.concat(item,'"]')).attr("opacity",.8)}))}),[highlightItems]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){}),[showCombined]);var displayIsNodata=(0,_hooks_useDisplayIsNodata__WEBPACK_IMPORTED_MODULE_6__.x)({dataSet:filteredDataSet,isLoading,isNodataComponent,isNodata});return(0,react__WEBPACK_IMPORTED_MODULE_0__.useLayoutEffect)((function(){renderCompleteRef.current=!0}),[]),(0,use_deep_compare_effect__WEBPACK_IMPORTED_MODULE_8__.Ay)((function(){if(renderCompleteRef.current&&onChartDataProcessed){var allDates=filteredDataSet.flatMap((function(set){return set.series.map((function(point){return"number"===xAxisDataType?point.date:String(point.date)}))})),currentMetadata={xAxisDomain:_toConsumableArray(new Set(allDates)).map((function(date){return String(date)})),yAxisDomain:yScale.domain(),visibleItems:filteredDataSet.map((function(d){return d.label})).filter((function(label){return!disabledItems.includes(label)})),renderedData:filteredDataSet.reduce((function(acc,d){return acc[d.label]=d.series,acc}),{}),chartType:"range-chart"},hasChanged=!prevChartDataRef.current||JSON.stringify(prevChartDataRef.current.xAxisDomain)!==JSON.stringify(currentMetadata.xAxisDomain)||JSON.stringify(prevChartDataRef.current.yAxisDomain)!==JSON.stringify(currentMetadata.yAxisDomain)||JSON.stringify(prevChartDataRef.current.visibleItems)!==JSON.stringify(currentMetadata.visibleItems)||JSON.stringify(Object.keys(prevChartDataRef.current.renderedData).sort())!==JSON.stringify(Object.keys(currentMetadata.renderedData).sort());prevChartDataRef.current=currentMetadata,hasChanged&&onChartDataProcessed(currentMetadata)}}),[filteredDataSet,xAxisDataType,yScale,disabledItems,onChartDataProcessed]),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",{className:"chart-container",style:{position:"relative"}},isLoading&&isLoadingComponent&&react__WEBPACK_IMPORTED_MODULE_0__.createElement(react__WEBPACK_IMPORTED_MODULE_0__.Fragment,null,isLoadingComponent),isLoading&&!isLoadingComponent&&react__WEBPACK_IMPORTED_MODULE_0__.createElement(_shared_LoadingIndicator__WEBPACK_IMPORTED_MODULE_7__.A,null),displayIsNodata&&react__WEBPACK_IMPORTED_MODULE_0__.createElement(react__WEBPACK_IMPORTED_MODULE_0__.Fragment,null,isNodataComponent),!isLoading&&!displayIsNodata&&filteredDataSet.length>0&&react__WEBPACK_IMPORTED_MODULE_0__.createElement("svg",{className:"chart",width,height,ref:svgRef,style:{overflow:"visible"}},title&&react__WEBPACK_IMPORTED_MODULE_0__.createElement("text",{x:width/2,y:margin.top/2,textAnchor:"middle",className:"chart-title"},title),children,react__WEBPACK_IMPORTED_MODULE_0__.createElement(_shared_Title__WEBPACK_IMPORTED_MODULE_3__.A,{x:width/2,y:margin.top/2},title),filteredDataSet.length>0&&react__WEBPACK_IMPORTED_MODULE_0__.createElement(react__WEBPACK_IMPORTED_MODULE_0__.Fragment,null,react__WEBPACK_IMPORTED_MODULE_0__.createElement(_shared_XaxisLinear__WEBPACK_IMPORTED_MODULE_4__.A,{xScale,height,margin,xAxisFormat,xAxisDataType}),react__WEBPACK_IMPORTED_MODULE_0__.createElement(_shared_YaxisLinear__WEBPACK_IMPORTED_MODULE_5__.A,{yScale,width,height,margin,highlightZeroLine:!0,yAxisFormat}))),react__WEBPACK_IMPORTED_MODULE_0__.createElement("div",{ref:tooltipRef,className:"chart-tooltip",style:{opacity:0,pointerEvents:"none",position:"fixed"}}))};const __WEBPACK_DEFAULT_EXPORT__=RangeChart;RangeChart.__docgenInfo={description:"",methods:[],displayName:"RangeChart",props:{dataSet:{required:!0,tsType:{name:"Array",elements:[{name:"signature",type:"object",raw:"{\r\n  label: string;\r\n  color: string;\r\n  series: DataPointRangeChart[];\r\n}",signature:{properties:[{key:"label",value:{name:"string",required:!0}},{key:"color",value:{name:"string",required:!0}},{key:"series",value:{name:"Array",elements:[{name:"DataPointRangeChart"}],raw:"DataPointRangeChart[]",required:!0}}]}}],raw:"{\r\n  label: string;\r\n  color: string;\r\n  series: DataPointRangeChart[];\r\n}[]"},description:""},width:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"900 - MARGIN.left - MARGIN.right",computed:!1}},height:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"480 - MARGIN.top - MARGIN.bottom",computed:!1}},margin:{required:!1,tsType:{name:"signature",type:"object",raw:"{ top: number; right: number; bottom: number; left: number }",signature:{properties:[{key:"top",value:{name:"number",required:!0}},{key:"right",value:{name:"number",required:!0}},{key:"bottom",value:{name:"number",required:!0}},{key:"left",value:{name:"number",required:!0}}]}},description:"",defaultValue:{value:"{ top: 50, right: 50, bottom: 50, left: 50 }",computed:!1}},title:{required:!1,tsType:{name:"string"},description:""},yAxisDomain:{required:!1,tsType:{name:"tuple",raw:"[number, number]",elements:[{name:"number"},{name:"number"}]},description:""},yAxisFormat:{required:!1,tsType:{name:"signature",type:"function",raw:"(d: number) => string",signature:{arguments:[{type:{name:"number"},name:"d"}],return:{name:"string"}}},description:""},xAxisFormat:{required:!1,tsType:{name:"signature",type:"function",raw:"(d: number) => string",signature:{arguments:[{type:{name:"number"},name:"d"}],return:{name:"string"}}},description:""},xAxisDataType:{required:!1,tsType:{name:"union",raw:'"number" | "date_annual" | "date_monthly"',elements:[{name:"literal",value:'"number"'},{name:"literal",value:'"date_annual"'},{name:"literal",value:'"date_monthly"'}]},description:"",defaultValue:{value:'"number"',computed:!1}},tooltipFormatter:{required:!1,tsType:{name:"signature",type:"function",raw:"(\r\n  d: DataPointRangeChart,\r\n  series: DataPointRangeChart[],\r\n  dataSet: {\r\n    label: string;\r\n    color: string;\r\n    series: DataPointRangeChart[];\r\n  }[]\r\n) => string",signature:{arguments:[{type:{name:"DataPointRangeChart"},name:"d"},{type:{name:"Array",elements:[{name:"DataPointRangeChart"}],raw:"DataPointRangeChart[]"},name:"series"},{type:{name:"Array",elements:[{name:"signature",type:"object",raw:"{\r\n  label: string;\r\n  color: string;\r\n  series: DataPointRangeChart[];\r\n}",signature:{properties:[{key:"label",value:{name:"string",required:!0}},{key:"color",value:{name:"string",required:!0}},{key:"series",value:{name:"Array",elements:[{name:"DataPointRangeChart"}],raw:"DataPointRangeChart[]",required:!0}}]}}],raw:"{\r\n  label: string;\r\n  color: string;\r\n  series: DataPointRangeChart[];\r\n}[]"},name:"dataSet"}],return:{name:"string"}}},description:"",defaultValue:{value:"(d: DataPointRangeChart) =>\r\n`<div>${d.label} - ${d.date}: ${d?.valueMedium}</div>`",computed:!1}},showCombined:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},children:{required:!1,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""},isLoading:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},isLoadingComponent:{required:!1,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""},isNodataComponent:{required:!1,tsType:{name:"ReactReactNode",raw:"React.ReactNode"},description:""},isNodata:{required:!1,tsType:{name:"union",raw:"| boolean\r\n| ((\r\n    dataSet: {\r\n      label: string;\r\n      color: string;\r\n      series: DataPointRangeChart[];\r\n    }[]\r\n  ) => boolean)",elements:[{name:"boolean"},{name:"unknown"}]},description:""},onChartDataProcessed:{required:!1,tsType:{name:"signature",type:"function",raw:"(metadata: ChartMetadata) => void",signature:{arguments:[{type:{name:"ChartMetadata"},name:"metadata"}],return:{name:"void"}}},description:""},onHighlightItem:{required:!1,tsType:{name:"signature",type:"function",raw:"(labels: string[]) => void",signature:{arguments:[{type:{name:"Array",elements:[{name:"string"}],raw:"string[]"},name:"labels"}],return:{name:"void"}}},description:""}}}}}]);